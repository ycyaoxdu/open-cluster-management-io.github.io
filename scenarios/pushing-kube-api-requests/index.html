<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css"/>
  <link rel="stylesheet" href="/main.css"/>
  <link rel="shortcut icon" type="image/svg" href="/ocm.svg">
  <title>Open Cluster Management</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1PXKZXT157"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1PXKZXT157');
  </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">




<input id="current-lang" type="hidden" value="en">

<header class="navbar navbar-expand-md navbar-dark bd-navbar">
  <nav class="navbar navbar-expand-lg navbar-dark py-3 fixed-top">
    <div class="container-fluid flex-wrap flex-md-nowrap">
      <a href="/" class="navbar-brand">
        <img src="/ocm.svg" alt="" width="30" height="24" class="align-text-top">
        Open Cluster Management
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto ">
          <li class="nav-item pe-2">
            <a href="/community" class="nav-link text-light">Community</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/contribute" class="nav-link text-light">Contribute</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/concepts" class="nav-link text-light">Document</a>
          </li>
          <li class="nav-item dropdown pe-2">
            
            <a class="nav-link dropdown-toggle text-light" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">English</a>
            

            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              
              <li><a class="dropdown-item" href="#" id="to-zh">中文</a></li>
              
            </ul>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://www.youtube.com/channel/UC7xxOh2jBM5Jfwt3fsBzOZw" target="_blank">
                <i class="bi bi-youtube"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://github.com/open-cluster-management-io" target="_blank">
              <i class="bi bi-github"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://kubernetes.slack.com/?redir=%2Farchives%2FC01GE7YSUUF" target="_blank">
              <i class="bi bi-slack"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>
</div>
        <div class="row subject-padding">
            <div class="col-2 col-md-3 padding-none sidebar-bgc">




<div class="sidebar-toggle sidebar-toggle-sm">
    <button type="button" id="sidebarToggle" class="btn btn-info">
        <i class="bi bi-list"></i>
    </button>
</div>
<nav id="sidebar" class="sidebar-hide-sm">
    <ul class="components">
        <li id="concepts">
            <a class="navlink" href="/concepts">Concepts</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/concepts/architecture">Architecture</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/managedcluster">ManagedCluster</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/manifestwork">ManifestWork</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/managedclusterset">ManagedClusterSet</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/placement">Placement</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/addon">Add-ons</a>
                </li>
            </ul>
        </li>
        <li id="getting-started">
            <a class="navlink" href="/getting-started">Getting Started</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/getting-started/quick-start">Quick Start</a>
                </li>
                <li>
                    <a class="navlink" href="/getting-started/core">Core Components</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/getting-started/core/cluster-manager">Cluster Manager</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/core/register-cluster">Klusterlet Agent</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/getting-started/integration">Add-ons and Integrations</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/getting-started/integration/app-lifecycle">Application lifecycle management</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/cluster-proxy">Cluster proxy</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/policy-framework">Policy framework</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/policy-controllers">Policy controllers</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/managed-serviceaccount">Managed service account</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/getting-started/administration">Administration</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/getting-started/administration/upgrading">Upgrading</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li id="scenarios">
            <a class="navlink" href="/scenarios">Scenarios</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/scenarios/deploy-kubernetes-resources">Deploy Kubernetes Resources</a>
                </li>
                <li>
                    <a class="navlink" href="/scenarios/extending-managed-clusters">Extend Managed Clusters</a>
                </li>
                <li>
                    <a class="navlink" href="/scenarios/pushing-kube-api-requests">Pushing Kube API Requests to the Managed Clusters</a>
                </li>
            </ul>
        </li>
        <li id="community">
            <a class="navlink" href="/community">Community</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/community/releases">Releases</a>
                </li>
                <li >
                    <a class="navlink" href="/community/roadmap">Roadmap</a>
                </li>
            </ul>
        </li>
        <li id="contribute">
            <a class="navlink" href="/contribute">Contribute</a>
        </li>
        <li id="blog">
            <a class="navlink" href="/blog">Blog</a>
        </li>
        <li style="padding-top: 10px; border-top: 2px solid #448a78;">
            <a class="navlink resource" href="https://github.com/open-cluster-management-io" target="_blank"><i class="bi bi-github"></i><span style="padding-left: 10px;">GitHub</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://kubernetes.slack.com/archives/C01GE7YSUUF" target="_blank"><i class="bi bi-slack"></i><span style="padding-left: 10px;">Slack</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://www.youtube.com/channel/UC7xxOh2jBM5Jfwt3fsBzOZw" target="_blank"><i class="bi bi-youtube"></i><span style="padding-left: 10px;">YouTube</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://groups.google.com/g/open-cluster-management" target="_blank"><i class="bi bi-envelope-fill"></i><span style="padding-left: 10px;">Mailing group</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://calendar.google.com/calendar/u/0/embed?src=openclustermanagement@gmail.com" target="_blank"><i class="bi bi-calendar-event-fill"></i><span style="padding-left: 10px;">Community meetings</span></a>
        </li>
    </ul>
</nav>
<script type="text/javascript" src="/sidebar.js"></script>
</div>
            <div class="col-10 col-md-9 padding-none">
<div id="content">
    <h1>Pushing Kubernetes API requests to the managed clusters</h1>
    <p>By following the instructions in this document, an OCM hub admin will be able
to &ldquo;push&rdquo; Kubernetes API requests to the managed clusters. The benefit of using
this method for &ldquo;pushing&rdquo; requests in OCM is that we don&rsquo;t need to explicitly
configure any API endpoint for the managed clusters or provide any client
credentials as preparation. We just need to enable/install the following OCM
addons:</p>
<ul>
<li><a href="https://github.com/open-cluster-management-io/cluster-proxy">Cluster-Proxy</a>:
Setting up the <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/setup-konnectivity/">konnectivity</a>
tunnels between the hub cluster and the managed clusters so the hub cluster
can connect/access the managed cluster from anywhere.</li>
<li><a href="https://github.com/open-cluster-management-io/managed-serviceaccount">Managed-ServiceAccount</a>:
Automating the lifecycle of the local service account in the managed clusters
and projecting the tokens back to the hub cluster so that the Kubernetes API
clients from the hub can make authenticated requests.</li>
<li><a href="https://github.com/oam-dev/cluster-gateway">Cluster-Gateway</a>: An aggregated
apiserver providing a &ldquo;proxy&rdquo; subresource which helps the hub admin to
gracefully access the managed clusters by standard Kubernetes API calls
(including long-running calls).</li>
</ul>
<h2 id="prerequisite">Prerequisite</h2>
<p>You must meet the following prerequisites to install the managed service
account:</p>
<ul>
<li>Ensure your <code>open-cluster-management</code> release is greater than <code>v0.5.0</code>.</li>
<li>Ensure <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl"><code>kubectl</code></a> is installed.</li>
<li>Ensure <a href="https://helm.sh/docs/intro/install/"><code>helm</code></a> is installed.</li>
</ul>
<h2 id="installation">Installation</h2>
<h3 id="adding-helm-chart-repo">Adding helm chart repo</h3>
<p>Making sure the following OCM addons are discovered by your helm environment:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ helm repo add ocm https://open-cluster-management.oss-us-west-1.aliyuncs.com
$ helm repo update
$ helm search repo ocm
NAME                             	CHART VERSION	APP VERSION	DESCRIPTION                                   
ocm/cluster-gateway-addon-manager	1.1.10        	1.0.0      	A Helm chart <span style="color:#66d9ef">for</span> Cluster-Gateway Addon-Manager
ocm/cluster-proxy                	0.1.4        	1.0.0      	A Helm chart <span style="color:#66d9ef">for</span> Cluster-Proxy OCM Addon      
ocm/managed-serviceaccount       	0.1.1        	1.0.0      	A Helm chart <span style="color:#66d9ef">for</span> Managed ServiceAccount Addon 
</code></pre></div><h3 id="install-the-ocm-addons">Install the OCM addons</h3>
<p>By the following helm commands to install the addons:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ helm -n open-cluster-management-addon install cluster-proxy ocm/cluster-proxy
$ helm -n open-cluster-management-addon install managed-serviceaccount ocm/managed-serviceaccount
$ helm -n open-cluster-management-addon install cluster-gateway ocm/cluster-gateway-addon-manager <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#75715e"># Delegating for secret discovery to &#34;managed-serviceaccount&#34; addon.</span>
    <span style="color:#75715e"># Skip the option for manual secret management.</span>
    --set manualSecretManagement<span style="color:#f92672">=</span>false <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#75715e"># Enabling konnectivity tunnels via &#34;cluster-proxy&#34; addon.</span>
    <span style="color:#75715e"># Skip the option if the hub cluster and the managed clusters are already mutually accessible.</span>
    --set konnectivityEgress<span style="color:#f92672">=</span>true
</code></pre></div><h3 id="confirm-addon-installation">Confirm addon installation</h3>
<p>The commands above installs the addon manager into the hub cluster, and the
manager will creating <code>ManagedClusterAddon</code> automatically into the cluster
namespaces representing the addon is plumbed into the managed cluster. In order
to check their status, run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl get managedclusteraddon -A
NAMESPACE   NAME                     AVAILABLE   DEGRADED   PROGRESSING
managed1    cluster-gateway          True
managed1    cluster-proxy            True                   
managed1    managed-serviceaccount   True 
</code></pre></div><p>Furthermore, after the addons are all deployed successfully, the hub admin will
be able to see a new resource named <code>ClusterGateway</code> registered into the hub
cluster:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl get clustergateway
NAME       PROVIDER   CREDENTIAL-TYPE       ENDPOINT-TYPE
managed1              ServiceAccountToken   ClusterProxy
</code></pre></div><h2 id="usage">Usage</h2>
<p>Now the gateway is ready for proxying your requests to the managed clusters
dynamically. The easiest way to verify if the proxying framework is working
is to run the following command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ export CLUSTER_NAME<span style="color:#f92672">=</span>managed1 <span style="color:#75715e"># Or any other valid managed cluster name</span>
$ kubectl get --raw<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/apis/cluster.core.oam.dev/v1alpha1/clustergateways/</span><span style="color:#e6db74">${</span>CLUSTER_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">/proxy/healthz&#34;</span>
ok
</code></pre></div><p>Another nice feature is that you can also easily convert the kubeconfig of the
hub cluster into a managed cluster&rsquo;s kubeconfig by adding the api suffix to the
cluster endpoint in your kubeconfig:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">$ # Copy and edit your original hub kubeconfig into e.g. managed1.kubeconfig
apiVersion: v1
clusters:
...
<span style="color:#f92672">---    server: https://x.x.x.x
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+++    server: https://x.x.x.x/apis/cluster.core.oam.dev/v1alpha1/clustergateways/${CLUSTER_NAME}/proxy
</span></code></pre></div><p>Then we can access the managed cluster directly via kubectl with the tweaked
kubeconfig:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ KUBECONFIG<span style="color:#f92672">=</span>managed1.kubeconfig kubectl get ns
</code></pre></div><p>However upon your first-time installation, you may encounter the RBAC
restriction message such as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Error from server (Forbidden): namespaces is forbidden: User &#34;system:serviceaccount:open-cluster-management-managed-serviceaccount:cluster-gateway&#34; cannot list resource &#34;namespaces&#34; in API group &#34;&#34; at the cluster scope
</code></pre></div><p>That is because we haven&rsquo;t set up proper RBAC permissions for the <code>egress</code>
service account managed by the <code>ManagedServiceAccount</code> yet. After granting
sufficient permissions for the service account in the managed clusters, you
will be able to freely operate the managed cluster from the hub without asking
for any credential or kubeconfig from the managed clusters. Note that the
service account is also periodically rotated by the addons so there&rsquo;s no need
to worry in sustainable credential management.</p>
<h2 id="insight">Insight</h2>
<p>Overall, the following picture of architecture reveals the internal technique
of the request &ldquo;pushing&rdquo; framework in the OCM:</p>
<div style="text-align: center; padding: 20px;">
   <img src="/proxy-framework.png" alt="Cluster proxy architecture" style="margin: 0 auto; width: 90%">
</div>
<p>With the help of the framework, we can easily develop a web service or an
operator that runs in the hub cluster and is able to access to the managed
clusters through the gateway. Note that it&rsquo;s generally not recommended to
list-watch the managed clusters from the hub because it&rsquo;s in a sense violating
the original philosophy of &ldquo;pull&rdquo; or &ldquo;hub-agent&rdquo; architecture of OCM. In
order to coordinate the hub cluster and the managed clusters in your custom
system, consider build your own OCM addon based on the <a href="https://github.com/open-cluster-management-io/addon-framework">addon-framework</a>
which provides you utilities for further customization.</p>

</div>
<script type="text/javascript" src="/clipboard-copy.js"></script>
</div>
        </div>
        <div class="row"><nav class="ocm navbar navbar-expand-lg navbar-dark py-3">
  <div class="container-fluid flex-wrap flex-md-nowrap">
    <div class="text-light">&copy; 2021 Open Cluster Management Authors. The Linux Foundation® (TLF) has registered trademarks and uses trademarks. For a list of TLF trademarks, see <a href="https://www.linuxfoundation.org/trademark-usage/" target="_blank" style="color: #f8f9fa;">Trademark Usage</a></div>
  </div>
</nav>
<script type="text/javascript" src="/lang.js"></script>
</div>
    </div>
</body>
</html>
