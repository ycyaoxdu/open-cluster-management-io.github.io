<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css"/>
  <link rel="stylesheet" href="/main.css"/>
  <link rel="shortcut icon" type="image/svg" href="/ocm.svg">
  <title>Open Cluster Management</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1PXKZXT157"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1PXKZXT157');
  </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">



    


<input id="current-lang" type="hidden" value="zh">

<header class="navbar navbar-expand-md navbar-dark bd-navbar">
  <nav class="navbar navbar-expand-lg navbar-dark py-3 fixed-top">
    <div class="container-fluid flex-wrap flex-md-nowrap">
      <a href="/zh/" class="navbar-brand">
        <img src="/ocm.svg" alt="" width="30" height="24" class="align-text-top">
        Open Cluster Management
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto ">
          <li class="nav-item pe-2">
            <a href="/zh/community" class="nav-link text-light">社区</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/zh/contribute" class="nav-link text-light">贡献</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/zh/concepts" class="nav-link text-light">文档</a>
          </li>
          <li class="nav-item dropdown pe-2">
            
            <a class="nav-link dropdown-toggle text-light" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">中文</a>
            

            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              
              <li><a class="dropdown-item" href="#" id="to-en">English</a></li>
              
            </ul>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://www.youtube.com/c/OpenClusterManagement" target="_blank">
                <i class="bi bi-youtube"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://github.com/open-cluster-management-io" target="_blank">
              <i class="bi bi-github"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://kubernetes.slack.com/channels/open-cluster-mgmt" target="_blank">
              <i class="bi bi-slack"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>
</div>
        <div class="row subject-padding">
            <div class="col-2 col-md-3 padding-none sidebar-bgc">



    


<div class="sidebar-toggle sidebar-toggle-sm">
    <button type="button" id="sidebarToggle" class="btn btn-info">
        <i class="bi bi-list"></i>
    </button>
</div>
<nav id="sidebar" class="sidebar-hide-sm">
    <ul class="components">
        <li id="concepts">
            <a class="navlink" href="/zh/concepts">概念</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/concepts/architecture">架构</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/clusterclaim">集群声明</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/managedcluster">托管集群</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/manifestwork">资源下发</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/managedclusterset">托管集群分组</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/placement">匹配路由</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/addon">自定义插件</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/policy">Policy</a>
                </li>
            </ul>
        </li>
        <li id="getting-started">
            <a class="navlink" href="/zh/getting-started">安装</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/getting-started/quick-start">快速开始</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/core">核心组件</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/zh/getting-started/core/cluster-manager">中枢控制器</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/core/register-cluster">集群代理控制器</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/integration">插件和集成</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/app-lifecycle">应用生命周期管理</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/cluster-proxy">多集群网络隧道</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/policy-framework">Policy框架</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/policy-controllers">Policy控制器</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/managed-serviceaccount">托管多集群ServiceAccount</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/administration">运维管理</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/zh/getting-started/administration/upgrading">升级版本</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li id="developer-guides">
            <a class="navlink" href="/zh/developer-guides">开发指南</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/developer-guides/addon">Add-on 开发指南</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/developer-guides/vscode-extension">VScode Extension</a>
                </li>
            </ul>
        </li>
        <li id="scenarios">
            <a class="navlink" href="/zh/scenarios">应用场景</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/scenarios/deploy-kubernetes-resources">部署Kubernetes资源</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/distribute-workload-with-placement">通过placement分发工作负载</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/extend-multicluster-scheduling-capabilities">扩展多集群调度能力</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/extending-managed-clusters">扩展集群模型</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/integration-with-argocd">集成Argo CD</a>
                </li>                
                <li>
                    <a class="navlink" href="/zh/scenarios/pushing-kube-api-requests">向托管集群推送Kube API请求</a>
                </li>
            </ul>
        </li>
        <li id="community">
            <a class="navlink" href="/zh/community">社区</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/community/releases">发行版本</a>
                </li>
                <li >
                    <a class="navlink" href="/zh/community/roadmap">社区规划</a>
                </li>
            </ul>
        </li>
        <li id="contribute">
            <a class="navlink" href="/zh/contribute">贡献</a>
        </li>
        <li id="blog">
            <a class="navlink" href="/zh/blog">博客</a>
        </li>
        <li style="padding-top: 10px; border-top: 2px solid #448a78;">
            <a class="navlink resource" href="https://github.com/open-cluster-management-io" target="_blank"><i class="bi bi-github"></i><span style="padding-left: 10px;">GitHub</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://kubernetes.slack.com/channels/open-cluster-mgmt" target="_blank"><i class="bi bi-slack"></i><span style="padding-left: 10px;">Slack</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://www.youtube.com/c/OpenClusterManagement" target="_blank"><i class="bi bi-youtube"></i><span style="padding-left: 10px;">YouTube</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://groups.google.com/g/open-cluster-management" target="_blank"><i class="bi bi-envelope-fill"></i><span style="padding-left: 10px;">Mailing group</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://calendar.google.com/calendar/u/0/embed?src=openclustermanagement@gmail.com" target="_blank"><i class="bi bi-calendar-event-fill"></i><span style="padding-left: 10px;">Community meetings</span></a>
        </li>
    </ul>
</nav>
<script type="text/javascript" src="/sidebar.js"></script>
</div>
            <div class="col-10 col-md-9 padding-none">
<div id="content">
    <h1>Integration with Argo CD</h1>
    <p><a href="https://argo-cd.readthedocs.io/en/stable/">Argo CD</a> is a declarative, GitOps continuous delivery tool, which allows developers to define and control deployment of Kubernetes application resources from within their existing Git workflow. By integrating Open Cluster Management (OCM) with Argo CD, it enables both automation and greater flexibility managing Argo CD Applications across a large number of OCM managed clusters.</p>
<p>In this article, we want to show you how to integrate Argo CD with OCM and deploy application to OCM managed clusters by leveraging the <code>Placement</code> API, which supports multi-cluster scheduling.</p>
<p>Before starting with the following steps, we suggest you understand the content below:</p>
<ul>
<li><a href="https://argo-cd.readthedocs.io/en/stable/user-guide/application-set/">Argo CD ApplicationSet</a>. It adds Application automation and seeks to improve multi-cluster support and cluster multitenant support within Argo CD.</li>
<li><a href="https://open-cluster-management.io/concepts/placement/">OCM Placement API</a>. It is used to dynamically select a set of <a href="https://open-cluster-management.io/concepts/managedcluster/">ManagedClusters</a> in one or multiple <a href="https://open-cluster-management.io/concepts/managedclusterset">ManagedClusterSets</a> so that the workloads can be deployed to these clusters.</li>
</ul>
<p>The first half of the
<a href="/kubecon-na-2022-ocm-multicluster-app-and-config-management.pdf">KubeCon NA 2022 - OCM Multicluster App &amp; Config Management</a>
also covers the integration with ArgoCD.</p>
<h3 id="how-it-works">How it works</h3>
<div style="text-align: center; padding: 20px;">
   <img src="/integration-with-argocd.png" alt="How it works" style="margin: 0 auto; width: 75%">
</div>
<p><strong>1. Import Kubernetes clusters to the OCM hub as managed clusters and organize them with managed clustersets.</strong></p>
<p><strong>2. Register the OCM managed clusters to ArgoCD.</strong></p>
<p>The OCM managed clusters can be registered to Argo CD one by one manually by using Argo CD CLI. It may take time to finish it if there are a large number of clusters. In order to make the cluster registration easier, consider to use <a href="https://github.com/open-cluster-management-io/multicloud-integrations">multicloud-integrations</a> to automate the procedure.</p>
<p><strong>3. Create a configuration of <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators-Cluster-Decision-Resource/">Cluster Decision Resource generator</a> by using OCM Placement API.</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt; EOF | kubectl apply -f -
</span><span style="color:#e6db74">apiVersion: v1
</span><span style="color:#e6db74">kind: ConfigMap
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  name: ocm-placement-generator
</span><span style="color:#e6db74">  namespace: argocd
</span><span style="color:#e6db74">data:
</span><span style="color:#e6db74">  apiVersion: cluster.open-cluster-management.io/v1beta1
</span><span style="color:#e6db74">  kind: placementdecisions
</span><span style="color:#e6db74">  statusListKey: decisions
</span><span style="color:#e6db74">  matchKey: clusterName
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p>With reference to this generator, an <code>ApplicationSet</code> can target the application to the clusters listed in the status of a set of <code>PlacementDecision</code>, which belong to a certian Placement.</p>
<p><strong>4. Grant Argo CD permissions to access OCM resoruces.</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt; EOF | kubectl apply -f -
</span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span><span style="color:#e6db74">kind: Role
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  name: ocm-placement-consumer
</span><span style="color:#e6db74">  namespace: argocd
</span><span style="color:#e6db74">rules:
</span><span style="color:#e6db74">- apiGroups: [&#34;cluster.open-cluster-management.io&#34;]
</span><span style="color:#e6db74">  resources: [&#34;placementdecisions&#34;]
</span><span style="color:#e6db74">  verbs: [&#34;get&#34;, &#34;list&#34;]
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">---
</span><span style="color:#e6db74">apiVersion: rbac.authorization.k8s.io/v1
</span><span style="color:#e6db74">kind: RoleBinding
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  name: ocm-placement-consumer:argocd
</span><span style="color:#e6db74">  namespace: argocd
</span><span style="color:#e6db74">roleRef:
</span><span style="color:#e6db74">  apiGroup: rbac.authorization.k8s.io
</span><span style="color:#e6db74">  kind: Role
</span><span style="color:#e6db74">  name: ocm-placement-consumer
</span><span style="color:#e6db74">subjects:
</span><span style="color:#e6db74">- kind: ServiceAccount
</span><span style="color:#e6db74">  namespace: argocd
</span><span style="color:#e6db74">  name: argocd-applicationset-controller
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p><strong>5. Bind at least one managed clusterset to the <code>argocd</code> namespace.</strong></p>
<p>For example, in order to bind the <code>global</code> managed clusterset to the <code>argocd</code> namespace, the user must have an RBAC rule to <code>create</code> on the virtual subresource of <code>managedclustersets/bind</code> of the <code>global</code> managed clusterset.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">clusteradm clusterset bind global --namespace argocd
</code></pre></div><p>The above command will create a <code>ManagedClusterSetBinding</code> resource in the <code>argocd</code> namespace. Normally, it should not be included by an application in the git repo because applying it to a Kubernetes cluster needs additional permissions.</p>
<p><strong>6. Create a placement in the <code>argocd</code> namespace to select some managed clusters.</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt; EOF | kubectl apply -f -
</span><span style="color:#e6db74">apiVersion: cluster.open-cluster-management.io/v1beta1
</span><span style="color:#e6db74">kind: Placement
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  name: guestbook-app-placement
</span><span style="color:#e6db74">  namespace: argocd
</span><span style="color:#e6db74">spec:
</span><span style="color:#e6db74">  numberOfClusters: 10
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p><strong>7. Create an <code>ApplicationSet</code> in the <code>argocd</code> namespace.</strong></p>
<p>The <code>ApplicationSet</code> has references to the Cluster Decision Resource generator previously created and placement. This will help Argo CD to determine where the application should be deployed. The managed clusters selected by the referenced placement may be changed dynamically. By setting <code>requeueAfterSeconds</code> of the generator in the <code>ApplicationSet</code> spec, the Argo CD will check the cluster decisions of the referenced placement periodically and ensure the application is deployed to the correct managed clusters.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt; EOF | kubectl apply -f -
</span><span style="color:#e6db74">apiVersion: argoproj.io/v1alpha1
</span><span style="color:#e6db74">kind: ApplicationSet
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  name: guestbook-app
</span><span style="color:#e6db74">  namespace: argocd
</span><span style="color:#e6db74">spec:
</span><span style="color:#e6db74">  generators:
</span><span style="color:#e6db74">    - clusterDecisionResource:
</span><span style="color:#e6db74">        configMapRef: ocm-placement-generator
</span><span style="color:#e6db74">        labelSelector:
</span><span style="color:#e6db74">          matchLabels:
</span><span style="color:#e6db74">            cluster.open-cluster-management.io/placement: guestbook-app-placement
</span><span style="color:#e6db74">        requeueAfterSeconds: 30
</span><span style="color:#e6db74">  template:
</span><span style="color:#e6db74">    metadata:
</span><span style="color:#e6db74">      name: &#39;{{clusterName}}-guestbook-app&#39;
</span><span style="color:#e6db74">    spec:
</span><span style="color:#e6db74">      project: default
</span><span style="color:#e6db74">      source:
</span><span style="color:#e6db74">        repoURL: &#39;https://github.com/argoproj/argocd-example-apps.git&#39;
</span><span style="color:#e6db74">        targetRevision: HEAD
</span><span style="color:#e6db74">        path: guestbook
</span><span style="color:#e6db74">      destination:
</span><span style="color:#e6db74">        name: &#39;{{clusterName}}&#39;
</span><span style="color:#e6db74">        namespace: guestbook
</span><span style="color:#e6db74">      syncPolicy:
</span><span style="color:#e6db74">        automated:
</span><span style="color:#e6db74">          prune: true
</span><span style="color:#e6db74">        syncOptions:
</span><span style="color:#e6db74">          - CreateNamespace=true
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p><strong>8. Check the status of the <code>ApplicationSet</code> and the <code>Application</code>.</strong></p>
<p>Confirm the <code>ApplicationSet</code> is created and an <code>Application</code> is generated for each selected managed cluster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl -n argocd get applicationsets
NAME            AGE
guestbook-app   4s

$ kubectl -n argocd get applications
NAME                     SYNC STATUS   HEALTH STATUS
cluster1-guestbook-app   Synced        Progressing
cluster2-guestbook-app   Synced        Progressing
</code></pre></div><p>And on each selected managed cluster confirm the <code>Application</code> is running.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl -n guestbook get pods
NAME                           READY   STATUS    RESTARTS   AGE
guestbook-ui-6b689986f-cdrk8   1/1     Running   <span style="color:#ae81ff">0</span>          112s
</code></pre></div><h3 id="whats-next">What&rsquo;s next</h3>
<p>To build an OCM environment integrated with Argo CD with <code>KinD</code> clusters, see <a href="https://github.com/open-cluster-management-io/OCM/tree/main/solutions/deploy-argocd-apps">Deploy applications with Argo CD</a> for more details.</p>

</div>
<script type="text/javascript" src="/clipboard-copy.js"></script>
</div>
        </div>
        <div class="row"><nav class="ocm navbar navbar-expand-lg navbar-dark py-3">
  <div class="container-fluid flex-wrap flex-md-nowrap">
    <div class="text-light">&copy; 2021 Open Cluster Management Authors. The Linux Foundation® (TLF) has registered trademarks and uses trademarks. For a list of TLF trademarks, see <a href="https://www.linuxfoundation.org/trademark-usage/" target="_blank" style="color: #f8f9fa;">Trademark Usage</a></div>
  </div>
</nav>
<script type="text/javascript" src="/lang.js"></script>
</div>
    </div>
</body>
</html>
