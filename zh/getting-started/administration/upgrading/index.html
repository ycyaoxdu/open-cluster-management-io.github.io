<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css"/>
  <link rel="stylesheet" href="/main.css"/>
  <link rel="shortcut icon" type="image/svg" href="/ocm.svg">
  <title>Open Cluster Management</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1PXKZXT157"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1PXKZXT157');
  </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">



    


<input id="current-lang" type="hidden" value="zh">

<header class="navbar navbar-expand-md navbar-dark bd-navbar">
  <nav class="navbar navbar-expand-lg navbar-dark py-3 fixed-top">
    <div class="container-fluid flex-wrap flex-md-nowrap">
      <a href="/zh/" class="navbar-brand">
        <img src="/ocm.svg" alt="" width="30" height="24" class="align-text-top">
        Open Cluster Management
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto ">
          <li class="nav-item pe-2">
            <a href="/zh/community" class="nav-link text-light">社区</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/zh/contribute" class="nav-link text-light">贡献</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/zh/concepts" class="nav-link text-light">文档</a>
          </li>
          <li class="nav-item dropdown pe-2">
            
            <a class="nav-link dropdown-toggle text-light" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">中文</a>
            

            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              
              <li><a class="dropdown-item" href="#" id="to-en">English</a></li>
              
            </ul>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://www.youtube.com/channel/UC7xxOh2jBM5Jfwt3fsBzOZw" target="_blank">
                <i class="bi bi-youtube"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://github.com/open-cluster-management-io" target="_blank">
              <i class="bi bi-github"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://kubernetes.slack.com/?redir=%2Farchives%2FC01GE7YSUUF" target="_blank">
              <i class="bi bi-slack"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>
</div>
        <div class="row subject-padding">
            <div class="col-2 col-md-3 padding-none sidebar-bgc">



    


<div class="sidebar-toggle sidebar-toggle-sm">
    <button type="button" id="sidebarToggle" class="btn btn-info">
        <i class="bi bi-list"></i>
    </button>
</div>
<nav id="sidebar" class="sidebar-hide-sm">
    <ul class="components">
        <li id="concepts">
            <a class="navlink" href="/zh/concepts">概念</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/concepts/architecture">架构</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/managedcluster">托管集群</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/manifestwork">资源下发</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/managedclusterset">托管集群分组</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/placement">匹配路由</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/addon">自定义插件</a>
                </li>
            </ul>
        </li>
        <li id="getting-started">
            <a class="navlink" href="/zh/getting-started">安装</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/getting-started/quick-start">快速开始</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/core">核心组件</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/zh/getting-started/core/cluster-manager">中枢控制器</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/core/register-cluster">集群代理控制器</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/integration">插件和集成</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/app-lifecycle">应用生命周期管理</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/cluster-proxy">多集群网络隧道</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/policy-framework">Policy框架</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/policy-controllers">Policy控制器</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/managed-serviceaccount">托管多集群ServiceAccount</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/administration">运维管理</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/zh/getting-started/administration/upgrading">升级版本</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li id="scenarios">
            <a class="navlink" href="/zh/scenarios">应用场景</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/scenarios/deploy-kubernetes-resources">部署Kubernetes资源</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/extending-managed-clusters">扩展集群模型</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/pushing-kube-api-requests">向托管集群推送Kube API请求</a>
                </li>
            </ul>
        </li>
        <li id="community">
            <a class="navlink" href="/zh/community">社区</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/zh/community/releases">发行版本</a>
                </li>
                <li >
                    <a class="navlink" href="/zh/community/roadmap">社区规划</a>
                </li>
            </ul>
        </li>
        <li id="contribute">
            <a class="navlink" href="/zh/contribute">贡献</a>
        </li>
        <li id="blog">
            <a class="navlink" href="/zh/blog">博客</a>
        </li>
        <li style="padding-top: 10px; border-top: 2px solid #448a78;">
            <a class="navlink resource" href="https://github.com/open-cluster-management-io" target="_blank"><i class="bi bi-github"></i><span style="padding-left: 10px;">GitHub</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://kubernetes.slack.com/archives/C01GE7YSUUF" target="_blank"><i class="bi bi-slack"></i><span style="padding-left: 10px;">Slack</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://www.youtube.com/channel/UC7xxOh2jBM5Jfwt3fsBzOZw" target="_blank"><i class="bi bi-youtube"></i><span style="padding-left: 10px;">YouTube</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://groups.google.com/g/open-cluster-management" target="_blank"><i class="bi bi-envelope-fill"></i><span style="padding-left: 10px;">Mailing group</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://calendar.google.com/calendar/u/0/embed?src=openclustermanagement@gmail.com" target="_blank"><i class="bi bi-calendar-event-fill"></i><span style="padding-left: 10px;">Community meetings</span></a>
        </li>
    </ul>
</nav>
<script type="text/javascript" src="/sidebar.js"></script>
</div>
            <div class="col-10 col-md-9 padding-none">
<div id="content">
    <h1>Upgrading your OCM environment</h1>
    <!-- spellchecker-disable -->



  <div class="gdoc-toc gdoc-toc__level--6"><nav id="TableOfContents"><ul>
        <li><a href="#before-you-begin">Before you begin</a></li>
        <li><a href="#upgrade-command-line-tool">Upgrade command-line tool</a></li>
        <li><a href="#manual-upgrade">Manual Upgrade</a>
          <ul>
            <li><a href="#hub-cluster">Hub Cluster</a>
              <ul>
                <li><a href="#upgrading-the-registration-operator">Upgrading the registration-operator</a></li>
                <li><a href="#upgrading-the-core-components">Upgrading the core components</a></li>
              </ul>
            </li>
            <li><a href="#managed-clusters">Managed Clusters</a>
              <ul>
                <li><a href="#upgrading-the-registration-operator-1">Upgrading the registration-operator</a></li>
                <li><a href="#upgrading-the-agent-components">Upgrading the agent components</a></li>
                <li><a href="#confirm-the-upgrade">Confirm the upgrade</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul></nav><hr></div>


<!-- spellchecker-enable -->
<p>This page provides the suggested steps to upgrade your OCM environment
including both the hub cluster and the managed clusters. Overall the major
steps you should follow are:</p>
<ul>
<li>Read the release notes to confirm the latest OCM release version. <em>(Note that
some add-ons&rsquo; version might be different from OCM&rsquo;s overall release version.)</em></li>
<li>Upgrade your command line tools <code>clusteradm</code></li>
<li>Upgrade your <a href="https://open-cluster-management.io/getting-started/core/cluster-manager/">hub cluster</a></li>
<li>Upgrade your <a href="https://open-cluster-management.io/getting-started/core/register-cluster/">managed clusters</a></li>
</ul>
<h2 id="before-you-begin">Before you begin</h2>
<p>You must have an existing OCM environment and there&rsquo;s supposed to be
registration-operator running in your clusters. The registration-operators
is supposed to be installed if you&rsquo;re previously following our recommended
<a href="https://open-cluster-management.io/getting-started/quick-start/">quick start guide</a>
to set up your OCM. The operator is responsible for helping you upgrade the
other components on ease.</p>
<h2 id="upgrade-command-line-tool">Upgrade command-line tool</h2>
<p>In order to retrieve the latest version of OCM&rsquo;s command-line tool <code>clusteradm</code>,
run the following one-liner command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl -L https://raw.githubusercontent.com/open-cluster-management-io/clusteradm/main/install.sh | bash
</code></pre></div><p>Then you&rsquo;re supposed to see the following outputs:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Getting the latest clusteradm CLI...
Your system is darwin_amd64

clusteradm CLI is detected:
Reinstalling clusteradm CLI - /usr/local/bin/clusteradm...

Installing v0.1.0 OCM clusteradm CLI...
Downloading https://github.com/open-cluster-management-io/clusteradm/releases/download/v0.1.0/clusteradm_darwin_amd64.tar.gz ...
clusteradm installed into /usr/local/bin successfully.

To get started with clusteradm, please visit https://open-cluster-management.io/getting-started/
</code></pre></div><p>Also, your can confirm the installed cli version by running:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ clusteradm version
client		    version	:v0.1.0
server release	version	: ...
</code></pre></div><h2 id="manual-upgrade">Manual Upgrade</h2>
<h3 id="hub-cluster">Hub Cluster</h3>
<h4 id="upgrading-the-registration-operator">Upgrading the registration-operator</h4>
<p>Navigate into the namespace where you installed registration-operator (named
&ldquo;open-cluster-management&rdquo; by default) and edit the image version of its
deployment resource:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl -n open-cluster-management edit deployment cluster-manager
</code></pre></div><p>Then update the image tag version to your target release version, which is
exactly the OCM&rsquo;s overall release version.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">--- image: quay.io/open-cluster-management/registration-operator:&lt;old release&gt;
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ image: quay.io/open-cluster-management/registration-operator:&lt;new release&gt;
</span></code></pre></div><h4 id="upgrading-the-core-components">Upgrading the core components</h4>
<p>After the upgrading of registration-operator is done, it&rsquo;s about time to surge
the working modules of OCM. Go on and edit the <code>clustermanager</code> custom resource
to prescribe the registration-operator to perform the automated upgrading:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl edit clustermanager cluster-manager
</code></pre></div><p>In the content of <code>clustermanager</code> resource, you&rsquo;re supposed to see a few
images listed in its spec:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: operator.open-cluster-management.io/v1
<span style="color:#66d9ef">kind</span>: ClusterManager
<span style="color:#66d9ef">metadata</span>: ...
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">registrationImagePullSpec</span>: quay.io/open-cluster-management/registration:&lt;target release<span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">  workImagePullSpec: quay.io/open-cluster-management/work:&lt;target release&gt;</span>
  <span style="color:#75715e"># NOTE: Placement release versioning differs from the OCM root version, please refer to the release note.</span>
  <span style="color:#66d9ef">placementImagePullSpec</span>: quay.io/open-cluster-management/placement:&lt;target release&gt;
</code></pre></div><p>Replacing the old release version to the latest and commit the changes will
trigger the process of background upgrading. Note that the status of upgrade
can be actively tracked via the status of <code>clustermanager</code>, so if anything goes
wrong during the upgrade it should also be reflected in that status.</p>
<h3 id="managed-clusters">Managed Clusters</h3>
<h4 id="upgrading-the-registration-operator-1">Upgrading the registration-operator</h4>
<p>Similar to the process of upgrading hub&rsquo;s registration-operator, the only
difference you&rsquo;re supposed to notice when upgrading the managed cluster is
the name of deployment. Note that before running the following command, you
are expected to switch the context to access the managed clusters not the hub.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl -n open-cluster-management edit deployment klusterlet
</code></pre></div><p>Then repeatedly, update the image tag version to your target release version
and commit the changes will upgrade the registration-operator.</p>
<h4 id="upgrading-the-agent-components">Upgrading the agent components</h4>
<p>After the registration-operator is upgraded, move on and edit the corresponding
<code>klusterlet</code> custom resource to trigger the upgrading process in your managed
cluster:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl edit klusterlet klusterlet
</code></pre></div><p>In the spec of <code>klusterlet</code>, what is expected to be updated is also its image
list:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: operator.open-cluster-management.io/v1
<span style="color:#66d9ef">kind</span>: Klusterlet
<span style="color:#66d9ef">metadata</span>: ...
<span style="color:#66d9ef">spec</span>:
  ...
  <span style="color:#66d9ef">registrationImagePullSpec</span>: quay.io/open-cluster-management/registration:&lt;target release<span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">  workImagePullSpec: quay.io/open-cluster-management/work:&lt;target release&gt;</span>
</code></pre></div><p>After committing the updates, actively checking the status of the <code>klusterlet</code>
to confirm whether everything is correctly upgraded. And repeat the above steps
to each of the managed clusters to perform a cluster-wise progressive upgrade.</p>
<h4 id="confirm-the-upgrade">Confirm the upgrade</h4>
<p>Getting the overall status of the managed cluster will help you to detect the
availability in case any of the managed clusters are running into failure:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl get managedclusters
</code></pre></div><p>And the upgrading is all set if all the steps above is succeeded.</p>

</div>
<script type="text/javascript" src="/clipboard-copy.js"></script>
</div>
        </div>
        <div class="row"><nav class="ocm navbar navbar-expand-lg navbar-dark py-3">
  <div class="container-fluid flex-wrap flex-md-nowrap">
    <div class="text-light">&copy; 2021 Open Cluster Management Authors. The Linux Foundation® (TLF) has registered trademarks and uses trademarks. For a list of TLF trademarks, see <a href="https://www.linuxfoundation.org/trademark-usage/" target="_blank" style="color: #f8f9fa;">Trademark Usage</a></div>
  </div>
</nav>
<script type="text/javascript" src="/lang.js"></script>
</div>
    </div>
</body>
</html>
