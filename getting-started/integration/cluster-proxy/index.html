<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css"/>
  <link rel="stylesheet" href="/main.css"/>
  <link rel="shortcut icon" type="image/svg" href="/ocm.svg">
  <title>Open Cluster Management</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1PXKZXT157"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1PXKZXT157');
  </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">




<input id="current-lang" type="hidden" value="en">

<header class="navbar navbar-expand-md navbar-dark bd-navbar">
  <nav class="navbar navbar-expand-lg navbar-dark py-3 fixed-top">
    <div class="container-fluid flex-wrap flex-md-nowrap">
      <a href="/" class="navbar-brand">
        <img src="/ocm.svg" alt="" width="30" height="24" class="align-text-top">
        Open Cluster Management
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto ">
          <li class="nav-item pe-2">
            <a href="/community" class="nav-link text-light">Community</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/contribute" class="nav-link text-light">Contribute</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/concepts" class="nav-link text-light">Document</a>
          </li>
          <li class="nav-item dropdown pe-2">
            
            <a class="nav-link dropdown-toggle text-light" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">English</a>
            

            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              
              <li><a class="dropdown-item" href="#" id="to-zh">中文</a></li>
              
            </ul>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://www.youtube.com/channel/UC7xxOh2jBM5Jfwt3fsBzOZw" target="_blank">
                <i class="bi bi-youtube"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://github.com/open-cluster-management-io" target="_blank">
              <i class="bi bi-github"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://kubernetes.slack.com/?redir=%2Farchives%2FC01GE7YSUUF" target="_blank">
              <i class="bi bi-slack"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>
</div>
        <div class="row subject-padding">
            <div class="col-2 col-md-3 padding-none sidebar-bgc">




<div class="sidebar-toggle sidebar-toggle-sm">
    <button type="button" id="sidebarToggle" class="btn btn-info">
        <i class="bi bi-list"></i>
    </button>
</div>
<nav id="sidebar" class="sidebar-hide-sm">
    <ul class="components">
        <li id="concepts">
            <a class="navlink" href="/concepts">Concepts</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/concepts/architecture">Architecture</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/managedcluster">ManagedCluster</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/manifestwork">ManifestWork</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/managedclusterset">ManagedClusterSet</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/placement">Placement</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/addon">Add-ons</a>
                </li>
            </ul>
        </li>
        <li id="getting-started">
            <a class="navlink" href="/getting-started">Getting Started</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/getting-started/quick-start">Quick Start</a>
                </li>
                <li>
                    <a class="navlink" href="/getting-started/core">Core Components</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/getting-started/core/cluster-manager">Cluster Manager</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/core/register-cluster">Klusterlet Agent</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/getting-started/integration">Add-ons and Integrations</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/getting-started/integration/app-lifecycle">Application lifecycle management</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/cluster-proxy">Cluster proxy</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/policy-framework">Policy framework</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/policy-controllers">Policy controllers</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/managed-serviceaccount">Managed service account</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/getting-started/administration">Administration</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/getting-started/administration/upgrading">Upgrading</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li id="scenarios">
            <a class="navlink" href="/scenarios">Scenarios</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/scenarios/deploy-kubernetes-resources">Deploy Kubernetes Resources</a>
                </li>
                <li>
                    <a class="navlink" href="/scenarios/extending-managed-clusters">Extend Managed Clusters</a>
                </li>
                <li>
                    <a class="navlink" href="/scenarios/pushing-kube-api-requests">Pushing Kube API Requests to the Managed Clusters</a>
                </li>
            </ul>
        </li>
        <li id="community">
            <a class="navlink" href="/community">Community</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/community/releases">Releases</a>
                </li>
                <li >
                    <a class="navlink" href="/community/roadmap">Roadmap</a>
                </li>
            </ul>
        </li>
        <li id="contribute">
            <a class="navlink" href="/contribute">Contribute</a>
        </li>
        <li id="blog">
            <a class="navlink" href="/blog">Blog</a>
        </li>
        <li style="padding-top: 10px; border-top: 2px solid #448a78;">
            <a class="navlink resource" href="https://github.com/open-cluster-management-io" target="_blank"><i class="bi bi-github"></i><span style="padding-left: 10px;">GitHub</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://kubernetes.slack.com/archives/C01GE7YSUUF" target="_blank"><i class="bi bi-slack"></i><span style="padding-left: 10px;">Slack</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://www.youtube.com/channel/UC7xxOh2jBM5Jfwt3fsBzOZw" target="_blank"><i class="bi bi-youtube"></i><span style="padding-left: 10px;">YouTube</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://groups.google.com/g/open-cluster-management" target="_blank"><i class="bi bi-envelope-fill"></i><span style="padding-left: 10px;">Mailing group</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://calendar.google.com/calendar/u/0/embed?src=openclustermanagement@gmail.com" target="_blank"><i class="bi bi-calendar-event-fill"></i><span style="padding-left: 10px;">Community meetings</span></a>
        </li>
    </ul>
</nav>
<script type="text/javascript" src="/sidebar.js"></script>
</div>
            <div class="col-10 col-md-9 padding-none">
<div id="content">
    <h1>Cluster proxy</h1>
    <p><a href="https://github.com/open-cluster-management-io/cluster-proxy">Cluster proxy</a>
is an OCM addon providing L4 network connectivity from hub cluster to
the managed clusters without <strong>any additional requirement</strong> to the managed
cluster&rsquo;s network infrastructure by leveraging the Kubernetes official SIG
sub-project <a href="https://github.com/kubernetes-sigs/apiserver-network-proxy">apiserver-network-proxy</a>.</p>
<!-- spellchecker-disable -->



  <div class="gdoc-toc gdoc-toc__level--6"><nav id="TableOfContents"><ul>
        <li><a href="#background">Background</a>
          <ul>
            <li><a href="#about-apiserver-network-proxy">About apiserver-network-proxy</a></li>
          </ul>
        </li>
        <li><a href="#architecture">Architecture</a></li>
        <li><a href="#prerequisite">Prerequisite</a></li>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#usage">Usage</a>
          <ul>
            <li><a href="#command-line-tools">Command-line tools</a></li>
            <li><a href="#example-code">Example code</a></li>
          </ul>
        </li>
        <li><a href="#more-insight">More insight</a>
          <ul>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
            <li><a href="#related-materials">Related materials</a></li>
          </ul>
        </li>
      </ul></nav><hr></div>


<!-- spellchecker-enable -->
<h2 id="background">Background</h2>
<p>The original architecture of OCM allows a cluster from anywhere to be
registered and managed by OCM&rsquo;s control plane (i.e. the hub cluster)
as long as the <a href="https://open-cluster-management.io/getting-started/core/register-cluster/">klusterlet agent</a>
can reach hub cluster&rsquo;s endpoint. So the minimal requirement for the
managed cluster&rsquo;s network infrastructure in OCM is &ldquo;klusterlet -&gt; hub&rdquo;
connectivity. However, there are still some cases where the components
in the hub cluster hope to proactively dail/request the services in the
managed clusters which will need the &ldquo;hub -&gt; klusterlet&rdquo; connectivity on
the other hand. In addition to that, the cases can be even more complex
when each of the managed clusters are not in the same network.</p>
<p>Cluster proxy is aiming at seamlessly delivering the outbound L4 requests
to the services in the managed cluster&rsquo;s network without any assumptions
upon the infrastructure as long as the clusters are successfully registered.
Basically the connectivity provided by cluster proxy is working over the
secured reserve proxy tunnels established by the apiserver-network-proxy.</p>
<h3 id="about-apiserver-network-proxy">About apiserver-network-proxy</h3>
<p>Apiserver-network-proxy is the underlying technique of a Kubernetes&rsquo;
feature called <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/setup-konnectivity/">konnectivity egress-selector</a>
which is majorly for setting up a TCP-level proxy for kube-apiserver
to get access to the node/cluster network. Here are a few terms we need
to clarify before we elaborate on how the cluster proxy resolve multi-cluster
control plan network connectivity for us:</p>
<ul>
<li><strong>Proxy Tunnel</strong>: A Grpc long connection that multiplexes and transmits
TCP-level traffic from the proxy servers to the proxy agents. Note that
there will be only one tunnel instance between each pair of server and
agent.</li>
<li><strong>Proxy Server</strong>: An mTLS Grpc server opened for establishing tunnels
which is the traffic ingress of proxy tunnel.</li>
<li><strong>Proxy Agent</strong>: A mTLS Grpc agent that maintains the tunnel between the
server and is also the egress of the proxy tunnel.</li>
<li><strong>Konnectivity Client</strong>: The SDK library for talking through the tunnel.<br>
Applicable to any Golang client of which the <code>Dialer</code> is overridable.
Note that for non-golang clients, the proxy server also supports
HTTP-Connect based proxying as alternative.</li>
</ul>
<h2 id="architecture">Architecture</h2>
<p>Cluster proxy runs inside OCM&rsquo;s hub cluster as an addon manager which is
developed based on the <a href="https://open-cluster-management.io/concepts/addon/">Addon-Framework</a>.
The addon manager of cluster proxy will be responsible for:</p>
<ol>
<li>Managing the installation of proxy servers in the hub cluster.</li>
<li>Managing the installation of proxy agents in the managed cluster.</li>
<li>Collecting healthiness and the other stats consistently in the hub cluster.</li>
</ol>
<p>The following picture shows the overall architecture of cluster proxy:</p>
<div style="text-align: center; padding: 20px;">
   <img src="/cluster-proxy-architecture.png" alt="Cluster proxy architecture" style="margin: 0 auto; width: 60%">
</div>
<p>Note that the green lines in the picture above is the active proxy tunnels
between proxy servers and agents, and HA setup is natively supported by
apiserver-network-proxy both for the servers and the agents. The orange
dash line started by the konnectivity client is the path of how the traffic
flows from the hub cluster to arbitrary managed clusters. Meanwhile the core
components including registration and work will help us manage the lifecycle
of all the components distributed in the multiple managed clusters, so the
hub admin won&rsquo;t need to directly operate the managed clusters to install
or configure the proxy agents no more.</p>
<h2 id="prerequisite">Prerequisite</h2>
<p>You must meet the following prerequisites to install the cluster-proxy:</p>
<ul>
<li>
<p>Ensure your <code>open-cluster-management</code> release is greater than <code>v0.5.0</code>.</p>
</li>
<li>
<p>Ensure <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl"><code>kubectl</code></a> is installed.</p>
</li>
<li>
<p>Ensure <a href="https://helm.sh/docs/intro/install/"><code>helm</code></a> is installed.</p>
</li>
</ul>
<h2 id="installation">Installation</h2>
<p>To install the cluster proxy addon to the OCM control plane, run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ helm repo add ocm https://open-cluster-management.oss-us-west-1.aliyuncs.com
$ helm repo update
$ helm search repo ocm
NAME                              	CHART VERSION	APP VERSION	DESCRIPTION                                   
ocm/cluster-proxy                 	v0.1.1       	1.0.0      	A Helm chart <span style="color:#66d9ef">for</span> Cluster-Proxy                
...
</code></pre></div><p>Then run the following helm command to install the cluster-proxy addon:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ helm install -n open-cluster-management-addon --create-namespace <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    cluster-proxy ocm/cluster-proxy 
$ kubectl -n open-cluster-management-addon get deploy
NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE
cluster-proxy                          3/3     <span style="color:#ae81ff">3</span>            <span style="color:#ae81ff">3</span>           24h
cluster-proxy-addon-manager            1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           24h
...
</code></pre></div><p>Then the addon manager of cluster-proxy will be created into the hub cluster
in the form of a deployment named <code>cluster-proxy-addon-manager</code>. As is also
shown above, the proxy servers will also be created as deployment resource
called <code>cluster-proxy</code>.</p>
<p>By default, the addon manager will be automatically discovering the addition
or removal the managed clusters and installs the proxy agents into them on
the fly. To check out the healthiness status of the proxy agents, we can run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$  kubectl get managedclusteraddon -A
NAMESPACE     NAME                     AVAILABLE   DEGRADED   PROGRESSING
&lt;cluster#1&gt;   cluster-proxy            True                   
&lt;cluster#2&gt;   cluster-proxy            True                   
</code></pre></div><p>The proxy agent distributed in the managed cluster will be periodically
renewing the lease lock of the addon instance.</p>
<h2 id="usage">Usage</h2>
<h3 id="command-line-tools">Command-line tools</h3>
<p>Using the <a href="https://open-cluster-management.io/getting-started/quick-start/#install-clusteradm-cli-tool">clusteradm</a>
to check the status of the cluster-proxy addon:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ clusteradm proxy health
CLUSTER NAME    INSTALLED    AVAILABLE    PROBED HEALTH    LATENCY
&lt;cluster#1&gt;     True         True         True             67.595144ms
&lt;cluster#2&gt;     True         True         True             85.418368ms
</code></pre></div><h3 id="example-code">Example code</h3>
<p>An <a href="https://github.com/open-cluster-management-io/cluster-proxy/blob/main/examples/test-client/main.go">example client</a>
in the cluster proxy repo shows us how to dynamically talk to the kube-apiserver
of a managed cluster from the hub cluster by simply prescribing the name of
the target cluster. Here&rsquo;s also a TL;DR code snippet:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 1. instantiate a dialing tunnel instance.
</span><span style="color:#75715e">// NOTE: recommended to be a singleton in your golang program.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">tunnel</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">konnectivity</span>.<span style="color:#a6e22e">CreateSingleUseGrpcTunnel</span>(
    <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(),
    &lt;<span style="color:#a6e22e">your</span> <span style="color:#a6e22e">proxy</span> <span style="color:#a6e22e">server</span> <span style="color:#a6e22e">endpoint</span>&gt;,
    <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithTransportCredentials</span>(<span style="color:#a6e22e">grpccredentials</span>.<span style="color:#a6e22e">NewTLS</span>(&lt;<span style="color:#a6e22e">your</span> <span style="color:#a6e22e">proxy</span> <span style="color:#a6e22e">server</span> <span style="color:#a6e22e">TLS</span> <span style="color:#a6e22e">config</span>&gt;)),
)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    panic(<span style="color:#a6e22e">err</span>)
}
<span style="color:#f92672">...</span>
<span style="color:#75715e">// 2. Overriding the Dialer to tunnel. Dialer is a common abstraction
</span><span style="color:#75715e">// in Golang SDK.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">Dial</span> = <span style="color:#a6e22e">tunnel</span>.<span style="color:#a6e22e">DialContext</span>
</code></pre></div><p>Another example will be <a href="https://github.com/oam-dev/cluster-gateway/blob/063b60e959ba607f0108c8b4cb99963f82f504b5/pkg/apis/cluster/v1alpha1/transport.go#L50-L58">cluster-gateway</a>
which is an aggregated apiserver optionally working over cluster-proxy for
routing traffic to the managed clusters dynamically in HTTPs protocol.</p>
<p>Note that by default the client credential for konnectivity client will be
persisted as secrets resources under the namespace where the addon-manager
is running. With that being said, to mount the secret to the systems in the
other namespaces, the users are expected to copy the secret on their own
manually.</p>
<h2 id="more-insight">More insight</h2>
<h3 id="troubleshooting">Troubleshooting</h3>
<p>The installation of proxy servers and agents are prescribed by the custom
resource called &ldquo;managedproxyconfiguration&rdquo;. We can check it out by the
following commands:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl get managedproxyconfiguration cluster-proxy -o yaml
apiVersion: proxy.open-cluster-management.io/v1alpha1
kind: ManagedProxyConfiguration
metadata: ...
spec:
  proxyAgent:
    image: &lt;expected image of the proxy agents&gt;
    replicas: &lt;expected replicas of proxy agents&gt;
  proxyServer:
    entrypoint:
      loadBalancerService:
        name: proxy-agent-entrypoint
      type: LoadBalancerService <span style="color:#75715e"># Or &#34;Hostname&#34; to set a fixed address</span>
                                <span style="color:#75715e"># for establishing proxy tunnels.</span>
    image: &lt;expected image of the proxy servers&gt;
    inClusterServiceName: proxy-entrypoint
    namespace: &lt;target namespace to install proxy server&gt;
    replicas: &lt;expected replicas of proxy servers&gt;
  authentication: <span style="color:#75715e"># Customize authentication between proxy server/agent</span>
status:
  conditions: ...
</code></pre></div><h3 id="related-materials">Related materials</h3>
<p>See the original <a href="https://github.com/open-cluster-management-io/enhancements/tree/main/enhancements/sig-architecture/14-addon-cluster-proxy">design proposal</a>
for reference.</p>

</div>
<script type="text/javascript" src="/clipboard-copy.js"></script>
</div>
        </div>
        <div class="row"><nav class="ocm navbar navbar-expand-lg navbar-dark py-3">
  <div class="container-fluid flex-wrap flex-md-nowrap">
    <div class="text-light">&copy; 2021 Open Cluster Management Authors. The Linux Foundation® (TLF) has registered trademarks and uses trademarks. For a list of TLF trademarks, see <a href="https://www.linuxfoundation.org/trademark-usage/" target="_blank" style="color: #f8f9fa;">Trademark Usage</a></div>
  </div>
</nav>
<script type="text/javascript" src="/lang.js"></script>
</div>
    </div>
</body>
</html>
