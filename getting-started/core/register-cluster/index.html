<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css"/>
  <link rel="stylesheet" href="/main.css"/>
  <link rel="shortcut icon" type="image/svg" href="/ocm.svg">
  <title>Open Cluster Management</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1PXKZXT157"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1PXKZXT157');
  </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">




<input id="current-lang" type="hidden" value="en">

<header class="navbar navbar-expand-md navbar-dark bd-navbar">
  <nav class="navbar navbar-expand-lg navbar-dark py-3 fixed-top">
    <div class="container-fluid flex-wrap flex-md-nowrap">
      <a href="/" class="navbar-brand">
        <img src="/ocm.svg" alt="" width="30" height="24" class="align-text-top">
        Open Cluster Management
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto ">
          <li class="nav-item pe-2">
            <a href="/community" class="nav-link text-light">Community</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/contribute" class="nav-link text-light">Contribute</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/concepts" class="nav-link text-light">Document</a>
          </li>
          <li class="nav-item dropdown pe-2">
            
            <a class="nav-link dropdown-toggle text-light" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">English</a>
            

            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              
              <li><a class="dropdown-item" href="#" id="to-zh">中文</a></li>
              
            </ul>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://www.youtube.com/channel/UC7xxOh2jBM5Jfwt3fsBzOZw" target="_blank">
                <i class="bi bi-youtube"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://github.com/open-cluster-management-io" target="_blank">
              <i class="bi bi-github"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://kubernetes.slack.com/?redir=%2Farchives%2FC01GE7YSUUF" target="_blank">
              <i class="bi bi-slack"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>
</div>
        <div class="row subject-padding">
            <div class="col-2 col-md-3 padding-none sidebar-bgc">




<div class="sidebar-toggle sidebar-toggle-sm">
    <button type="button" id="sidebarToggle" class="btn btn-info">
        <i class="bi bi-list"></i>
    </button>
</div>
<nav id="sidebar" class="sidebar-hide-sm">
    <ul class="components">
        <li id="concepts">
            <a class="navlink" href="/concepts">Concepts</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/concepts/architecture">Architecture</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/managedcluster">ManagedCluster</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/manifestwork">ManifestWork</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/managedclusterset">ManagedClusterSet</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/placement">Placement</a>
                </li>
                <li>
                    <a class="navlink" href="/concepts/addon">Add-ons</a>
                </li>
            </ul>
        </li>
        <li id="getting-started">
            <a class="navlink" href="/getting-started">Getting Started</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/getting-started/quick-start">Quick Start</a>
                </li>
                <li>
                    <a class="navlink" href="/getting-started/core">Core Components</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/getting-started/core/cluster-manager">Cluster Manager</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/core/register-cluster">Klusterlet Agent</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/getting-started/integration">Add-ons and Integrations</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/getting-started/integration/app-lifecycle">Application lifecycle management</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/cluster-proxy">Cluster proxy</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/policy-framework">Policy framework</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/policy-controllers">Policy controllers</a>
                        </li>
                        <li>
                            <a class="navlink" href="/getting-started/integration/managed-serviceaccount">Managed service account</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/getting-started/administration">Administration</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/getting-started/administration/upgrading">Upgrading</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li id="scenarios">
            <a class="navlink" href="/scenarios">Scenarios</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/scenarios/deploy-kubernetes-resources">Deploy Kubernetes Resources</a>
                </li>
                <li>
                    <a class="navlink" href="/scenarios/extending-managed-clusters">Extend Managed Clusters</a>
                </li>
                <li>
                    <a class="navlink" href="/scenarios/pushing-kube-api-requests">Pushing Kube API Requests to the Managed Clusters</a>
                </li>
            </ul>
        </li>
        <li id="community">
            <a class="navlink" href="/community">Community</a>
            <ul class="collapse">
                <li>
                    <a class="navlink" href="/community/releases">Releases</a>
                </li>
                <li >
                    <a class="navlink" href="/community/roadmap">Roadmap</a>
                </li>
            </ul>
        </li>
        <li id="contribute">
            <a class="navlink" href="/contribute">Contribute</a>
        </li>
        <li id="blog">
            <a class="navlink" href="/blog">Blog</a>
        </li>
        <li style="padding-top: 10px; border-top: 2px solid #448a78;">
            <a class="navlink resource" href="https://github.com/open-cluster-management-io" target="_blank"><i class="bi bi-github"></i><span style="padding-left: 10px;">GitHub</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://kubernetes.slack.com/archives/C01GE7YSUUF" target="_blank"><i class="bi bi-slack"></i><span style="padding-left: 10px;">Slack</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://www.youtube.com/channel/UC7xxOh2jBM5Jfwt3fsBzOZw" target="_blank"><i class="bi bi-youtube"></i><span style="padding-left: 10px;">YouTube</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://groups.google.com/g/open-cluster-management" target="_blank"><i class="bi bi-envelope-fill"></i><span style="padding-left: 10px;">Mailing group</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://calendar.google.com/calendar/u/0/embed?src=openclustermanagement@gmail.com" target="_blank"><i class="bi bi-calendar-event-fill"></i><span style="padding-left: 10px;">Community meetings</span></a>
        </li>
    </ul>
</nav>
<script type="text/javascript" src="/sidebar.js"></script>
</div>
            <div class="col-10 col-md-9 padding-none">
<div id="content">
    <h1>Klusterlet agent</h1>
    <p>After the cluster manager is installed on the hub cluster, you need to install the klusterlet agent on another cluster so that it can be registered and managed by the hub cluster.</p>
<!-- spellchecker-disable -->



  <div class="gdoc-toc gdoc-toc__level--6"><nav id="TableOfContents"><ul>
        <li><a href="#prerequisite">Prerequisite</a></li>
        <li><a href="#install-from-source">Install from source</a></li>
        <li><a href="#install-community-operator-from-operatorhubio">Install community operator from OperatorHub.io</a></li>
        <li><a href="#what-is-next">What is next</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
      </ul></nav><hr></div>


<!-- spellchecker-enable -->
<h2 id="prerequisite">Prerequisite</h2>
<p>Ensure <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl">kubectl</a> and <a href="https://kubernetes-sigs.github.io/kustomize/installation">kustomize</a> are installed.</p>
<p>Ensure <a href="https://golang.org/doc/install">golang</a> is installed, if you are planning to install from the source.</p>
<p>Ensure the open-cluster-management cluster manager is installed on the hub cluster. See <a href="../cluster-manager">Cluster manager</a> for more information.</p>
<p>Prepare another Kubernetes cluster to function as the managed cluster. For example, use <a href="https://kind.sigs.k8s.io/docs/user/quick-start">kind</a> to create another cluster as described in the following instructions. To use <code>kind</code>, you will need <a href="https://docs.docker.com/get-started">docker</a> installed and running.</p>
<p>Set the following environment variables that will be used throughout to simplify the instructions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">export MANAGED_CLUSTER_NAME<span style="color:#f92672">=</span>&lt;your managed cluster name&gt;     <span style="color:#75715e"># export MANAGED_CLUSTER_NAME=cluster1</span>
export CTX_MANAGED_CLUSTER<span style="color:#f92672">=</span>&lt;your managed cluster context&gt;   <span style="color:#75715e"># export CTX_MANAGED_CLUSTER=kind-cluster1</span>
</code></pre></div><p>Then create the managed cluster with <code>kind</code>, run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell"><span style="color:#75715e"># kind delete cluster --name ${MANAGED_CLUSTER_NAME} # if the kind cluster is previously created and can be safely deleted</span>
kind create cluster --name <span style="color:#e6db74">${</span>MANAGED_CLUSTER_NAME<span style="color:#e6db74">}</span>
</code></pre></div><p>If you are using OKD, OpenShift, you will need to prepare a kubeconfig with <code>certificate-authority-data</code>, <code>client-certificate-data</code> and <code>client-key-data</code>. By default, it&rsquo;s located in <code>auth/kubeconfig</code> under your installation folder.</p>
<h2 id="install-from-source">Install from source</h2>
<p>If you have not already done so, clone the <code>registration-operator</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">git clone https://github.com/open-cluster-management-io/registration-operator
</code></pre></div><p>Ensure the <code>kubectl</code> context is set to point to the managed cluster:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">kubectl config use-context <span style="color:#e6db74">${</span>CTX_MANAGED_CLUSTER<span style="color:#e6db74">}</span>
</code></pre></div><p>Deploy agent on a managed <code>kind</code> cluster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">cd registration-operator
make deploy-spoke <span style="color:#75715e"># make deploy-spoke GO_REQUIRED_MIN_VERSION:= # if you see warnings regarding go version</span>
</code></pre></div><h2 id="install-community-operator-from-operatorhubio">Install community operator from OperatorHub.io</h2>
<p>If you are using OKD, OpenShift, or have <code>OLM</code> installed in your cluster, you can install the klusterlet agent community operator with a released version from <a href="https://operatorhub.io/operator/klusterlet">OperatorHub.io</a>.</p>
<h2 id="what-is-next">What is next</h2>
<p>After a successful deployment, a <code>certificatesigningrequest</code> and a <code>managedcluster</code> will be created on the hub cluster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">$ kubectl get csr --context <span style="color:#e6db74">${</span>CTX_HUB_CLUSTER<span style="color:#e6db74">}</span>
NAME                              AGE   REQUESTOR                       CONDITION
<span style="color:#e6db74">${</span>MANAGED_CLUSTER_NAME<span style="color:#e6db74">}</span>-&lt;suffix&gt;   41s   kubernetes-admin                Pending
csr-&lt;suffix&gt;                      76m   system:node:hub-control-plane   Approved,Issued
$ kubectl get managedcluster --context <span style="color:#e6db74">${</span>CTX_HUB_CLUSTER<span style="color:#e6db74">}</span>
NAME                    HUB ACCEPTED   MANAGED CLUSTER URLS   JOINED   AVAILABLE   AGE
<span style="color:#e6db74">${</span>MANAGED_CLUSTER_NAME<span style="color:#e6db74">}</span>  false          https://localhost                           57s
</code></pre></div><p>Next approve the certificate and set managecluster to be accepted by the hub with following commands:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">kubectl certificate approve <span style="color:#f92672">{</span>csr name<span style="color:#f92672">}</span> --context <span style="color:#e6db74">${</span>CTX_HUB_CLUSTER<span style="color:#e6db74">}</span>
kubectl patch managedcluster <span style="color:#e6db74">${</span>MANAGED_CLUSTER_NAME<span style="color:#e6db74">}</span> -p<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;hubAcceptsClient&#34;:true}}&#39;</span> --type<span style="color:#f92672">=</span>merge --context <span style="color:#e6db74">${</span>CTX_HUB_CLUSTER<span style="color:#e6db74">}</span>
</code></pre></div><p>Run <code>kubectl get managedcluster --context ${CTX_HUB_CLUSTER}</code> again on the hub cluster. You should be able to see that the managed cluster is registered now.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">NAME                     HUB ACCEPTED   MANAGED CLUSTER URLS   JOINED   AVAILABLE   AGE
<span style="color:#e6db74">${</span>MANAGED_CLUSTER_NAME<span style="color:#e6db74">}</span>   true           https://localhost      True     True        7m58s
</code></pre></div><p>If the managed cluster status is not true, refer to <a href="#troubleshooting">Troubleshooting</a> to debug on your cluster.</p>
<p>After the managed cluster is registered, test that you can deploy a pod to the managed cluster from the hub cluster. Create a <code>manifest-work.yaml</code> as shown in this example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: work.open-cluster-management.io/v1
<span style="color:#66d9ef">kind</span>: ManifestWork
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: mw<span style="color:#ae81ff">-01</span>
  <span style="color:#66d9ef">namespace</span>: ${MANAGED_CLUSTER_NAME}
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">workload</span>:
    <span style="color:#66d9ef">manifests</span>:
      - <span style="color:#66d9ef">apiVersion</span>: v1
        <span style="color:#66d9ef">kind</span>: Pod
        <span style="color:#66d9ef">metadata</span>:
          <span style="color:#66d9ef">name</span>: hello
          <span style="color:#66d9ef">namespace</span>: default
        <span style="color:#66d9ef">spec</span>:
          <span style="color:#66d9ef">containers</span>:
            - <span style="color:#66d9ef">name</span>: hello
              <span style="color:#66d9ef">image</span>: busybox
              <span style="color:#66d9ef">command</span>: [<span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#39;echo &#34;Hello, Kubernetes!&#34; &amp;&amp; sleep 3600&#39;</span>]
          <span style="color:#66d9ef">restartPolicy</span>: OnFailure
</code></pre></div><p>Apply the yaml file to the hub cluster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">kubectl apply -f manifest-work.yaml --context <span style="color:#e6db74">${</span>CTX_HUB_CLUSTER<span style="color:#e6db74">}</span>
</code></pre></div><p>Verify that the <code>manifestwork</code> resource was applied to the hub.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">kubectl -n <span style="color:#e6db74">${</span>MANAGED_CLUSTER_NAME<span style="color:#e6db74">}</span> get manifestwork/mw-01 --context <span style="color:#e6db74">${</span>CTX_HUB_CLUSTER<span style="color:#e6db74">}</span> -o yaml
</code></pre></div><p>Check on the managed cluster and see the <em>hello</em> Pod has been deployed from the hub cluster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">$ kubectl -n default get pod --context <span style="color:#e6db74">${</span>CTX_MANAGED_CLUSTER<span style="color:#e6db74">}</span>
NAME    READY   STATUS    RESTARTS   AGE
hello   1/1     Running   <span style="color:#ae81ff">0</span>          108s
</code></pre></div><h2 id="troubleshooting">Troubleshooting</h2>
<ul>
<li>
<p>The managed cluster status is not true.</p>
<p>For example, the result below is shown when checking managedcluster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">$ kubectl get managedcluster --context <span style="color:#e6db74">${</span>CTX_HUB_CLUSTER<span style="color:#e6db74">}</span>
NAME                   HUB ACCEPTED   MANAGED CLUSTER URLS   JOINED   AVAILABLE   AGE
<span style="color:#e6db74">${</span>MANAGED_CLUSTER_NAME<span style="color:#e6db74">}</span> true           https://localhost               Unknown     46m
</code></pre></div><p>There are many reasons for this problem. You can use the commands below to get more debug info. If the provided info doesn&rsquo;t help, please log an issue to us.</p>
<p>On the hub cluster, check the managedcluster status.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">kubectl get managedcluster <span style="color:#e6db74">${</span>MANAGED_CLUSTER_NAME<span style="color:#e6db74">}</span> --context <span style="color:#e6db74">${</span>CTX_HUB_CLUSTER<span style="color:#e6db74">}</span> -o yaml
</code></pre></div><p>On the hub cluster, check the lease status.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">kubectl get lease -n <span style="color:#e6db74">${</span>MANAGED_CLUSTER_NAME<span style="color:#e6db74">}</span> --context <span style="color:#e6db74">${</span>CTX_HUB_CLUSTER<span style="color:#e6db74">}</span>
</code></pre></div><p>On the managed cluster, check the klusterlet status.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Shell" data-lang="Shell">kubectl get klusterlet -o yaml --context <span style="color:#e6db74">${</span>CTX_MANAGED_CLUSTER<span style="color:#e6db74">}</span>
</code></pre></div></li>
</ul>

</div>
<script type="text/javascript" src="/clipboard-copy.js"></script>
</div>
        </div>
        <div class="row"><nav class="ocm navbar navbar-expand-lg navbar-dark py-3">
  <div class="container-fluid flex-wrap flex-md-nowrap">
    <div class="text-light">&copy; 2021 Open Cluster Management Authors. The Linux Foundation® (TLF) has registered trademarks and uses trademarks. For a list of TLF trademarks, see <a href="https://www.linuxfoundation.org/trademark-usage/" target="_blank" style="color: #f8f9fa;">Trademark Usage</a></div>
  </div>
</nav>
<script type="text/javascript" src="/lang.js"></script>
</div>
    </div>
</body>
</html>
